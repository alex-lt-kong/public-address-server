<!DOCTYPE html>
<link rel="shortcut icon" href="//monitor.sz.lan/notification/static/favicon.png">
<link rel="stylesheet" href="//monitor.sz.lan/resources/w3.css">
<script src="//monitor.sz.lan/resources/monitor.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">

<html>
<head>
  <title>播放记录[{{username}}]</title>
  <script>	   
    window.onload = function() { logUserInteractions('[notification_playback/history] load'); };
    window.onunload = function() { logUserInteractions('[notification_playback/history] unload'); };
  </script>
</head>
<body>
<div class="w3-container w3-padding-16 w3-responsive" style="max-width: 100em; display: block; margin-left: auto; margin-right: auto;">
  <header class="w3-container w3-teal">
    <div class="w3-cell-row">
      <div class="w3-container w3-cell">
        <h3>播放记录</h3>
      </div>
      <div class="w3-container w3-cell w3-cell-middle">
        <button onclick="stopPlaying();" class="w3-right w3-white w3-border w3-button">
          停止播放
        </button>
        <div class="w3-right w3-dropdown-hover" style="margin-right: 1em;">
          <button class="w3-white w3-border w3-button">时间表&nbsp;▾</button>
          <div class="w3-dropdown-content w3-bar-block w3-card-4">
            <a href="../download_schedule/" class="w3-bar-item w3-button">下载</a>
            <a id="fileSelect" class="w3-bar-item w3-button" onclick="uploadSchedule()" >上传并应用</a>
            <form id="form-schedule-upload" method="post" enctype="multipart/form-data">
           <!--   <input id="input-select-file" type="file" name="selected_file">-->
              <input id="schedule-input" type="file" name="schedule-file" style="display: none;" />
            </form>
          </div>
        </div>
      </div>
    </div>
  </header> 
  <table class="w3-table-all w3-hoverable" style="width:100%;table-layout: auto;user-select: none;">
    <tr><th>时间</th><th>项目</th><th>歌名</th></tr>
    {% for i in range(0, playback_items|length) %}
      <tr onClick="manualPlayBack('{{username}}', {{playback_items[i][1]}}, '{{playback_items[i][2]}}');">
        <td>{{playback_items[i][0]}}</td>
        <td>{{playback_items[i][3]}}</td>
        <td>{{playback_items[i][2]}}</td>
      </tr>
    {% endfor %}
  </table> 
  <div id="msg-box" class="w3-modal">
    <div class="w3-modal-content w3-animate-top">
      <header class="w3-container w3-teal"> 
        <span onclick="document.getElementById('msg-box').style.display='none'" 
        class="w3-button w3-display-topright">&times;</span>
        <h2>提示</h2>
      </header>
      <div class="w3-container">
        <p id="msg-body"></p>
        <p><button id="okay-button" onclick="document.getElementById('msg-box').style.display='none';location.reload();" class="w3-right w3-button w3-teal">确定</button></p>
      </div>
    </div>
  </div>
</div>
</body>
<script>


document.getElementById('schedule-input').onchange = function() {

  console.log('onchange');

  const XHR = new XMLHttpRequest();
  XHR.timeout = 10000;
  const FD = new FormData(document.getElementById('form-schedule-upload'));
  console.log(FD)
  document.getElementById('okay-button').style.display = 'none';
  
  XHR.onreadystatechange = function(e) {
    
    if (XHR.readyState === 4) {
      document.getElementById('msg-box').style.display='block';
      if (XHR.status === 200) {
        document.getElementById('msg-body').innerHTML = '<div>' + XHR.responseText.toString() + '</div>';
      } else {
        document.getElementById('msg-body').innerHTML = '<b>错误</b>: 时间表上传/应用失败！，错误信息：<br><br>'
        document.getElementById('msg-body').innerHTML += XHR.responseText;
      }
      document.getElementById('okay-button').style.display = 'block';
    }
  }
  XHR.ontimeout = function () {
    document.getElementById('msg-body').innerHTML = '<b>错误</b>: 连接超时';
    document.getElementById('okay-button').style.display = 'block';
  }
    
  XHR.open('POST', '../upload_schedule/');
  XHR.send(FD);
};

function manualPlayBack(userName, musicID, musicName) {
  submission('//monitor.sz.lan/notification/play/?username=' + encodeURIComponent(userName) + 
             '&sound_index=' + encodeURIComponent(musicID), 
             '<span style=\'font-weight: bold;\'>' + musicName + '</span>已加入播放队列', 
             '[notification_playback_history] start playback ' + musicName);
}

function stopPlaying() {
  submission('https://monitor.sz.lan/notification/stop/?username={{username}}', 
             '播放已停止',
             '[notification_playback_history] stop playback');
}

function uploadSchedule() {
  document.getElementById('schedule-input').click();
  
}

function submission(url, msg, activityDescription){
  const xhr = new XMLHttpRequest();
  xhr.timeout = 5000;
  console.log("url: " + url);
  xhr.onreadystatechange = function(e) {
    if (xhr.readyState === 4) {
      console.log('xhr.responseText: ' + xhr.responseText);
      if (xhr.status === 200) {
        
      } else {
        msg = '指令发送错误：<br>' + xhr.responseText;
      }
      document.getElementById('msg-box').style.display='block';
      document.getElementById('msg-body').innerHTML= msg;
    }
  }
  xhr.ontimeout = function () {
    msg = '指令发送超时';
  }
  xhr.open('get', url, true)
  xhr.send();

  logUserInteractions(activityDescription);
}
</script>
</html>